<UserControl x:Class="MAAS_SFRThelper.Views.OptimizationView"
            xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
            xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
            xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
            xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
            xmlns:local="clr-namespace:MAAS_SFRThelper.Views"
            mc:Ignorable="d"
            d:DesignHeight="700" d:DesignWidth="900">

    <UserControl.Resources>
        <BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter"/>
    </UserControl.Resources>

    <Grid Margin="10">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>

        <!-- Title -->
        <TextBlock Grid.Row="0" 
                   Text="SFRT Optimization" 
                   FontSize="18" 
                   FontWeight="Bold" 
                   Margin="0,0,0,15"/>

        <!-- Structure Selection Section -->
        <GroupBox Grid.Row="1" 
                  Header="Structure Selection" 
                  Margin="0,0,0,10"
                  Padding="10">
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                </Grid.RowDefinitions>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="150"/>
                    <ColumnDefinition Width="*"/>
                </Grid.ColumnDefinitions>

                <TextBlock Grid.Row="0" Grid.Column="0" 
                           Text="Lattice (Peak):" 
                           VerticalAlignment="Center"
                           Margin="0,0,0,10"/>
                <ComboBox Grid.Row="0" Grid.Column="1"
                          ItemsSource="{Binding AvailableLatticeStructures}"
                          SelectedItem="{Binding SelectedLatticeStructure}"
                          Margin="0,0,0,10"
                          Height="25"/>

                <TextBlock Grid.Row="1" Grid.Column="0" 
                           Text="Valley (Low Dose):" 
                           VerticalAlignment="Center"
                           Margin="0,0,0,10"/>
                <ComboBox Grid.Row="1" Grid.Column="1"
                          ItemsSource="{Binding AvailableValleyStructures}"
                          SelectedItem="{Binding SelectedValleyStructure}"
                          Margin="0,0,0,10"
                          Height="25"/>

                <TextBlock Grid.Row="2" Grid.Column="0" 
                           Text="PTV Structure:" 
                           VerticalAlignment="Center"
                           Visibility="{Binding PTVSelectionVisible, Converter={StaticResource BooleanToVisibilityConverter}}"/>
                <ComboBox Grid.Row="2" Grid.Column="1"
                          ItemsSource="{Binding AvailablePTVStructures}"
                          SelectedItem="{Binding SelectedPTVStructure}"
                          Height="25"
                          Visibility="{Binding PTVSelectionVisible, Converter={StaticResource BooleanToVisibilityConverter}}"/>
            </Grid>
        </GroupBox>

        <!-- Optimization Parameters Section -->
        <!-- Optimization Parameters Section -->
        <GroupBox Grid.Row="2" 
          Header="Optimization Parameters" 
          Margin="0,0,0,10"
          Padding="10">
            <StackPanel>

                <!-- Peak Objectives Section -->
                <Border BorderBrush="LightGray" BorderThickness="1" Padding="10" Margin="0,0,0,10" Background="LightYellow">
                    <StackPanel>
                        <TextBlock Text="Peak Objectives (High Dose Regions)" 
                           FontWeight="Bold" FontSize="13"
                           Margin="0,0,0,10"/>

                        <TextBlock TextWrapping="Wrap" Margin="0,0,0,5">
                    <Run Text="Structure: " FontWeight="SemiBold"/>
                    <Run Text="{Binding SelectedLatticeStructure, Mode=OneWay}" Foreground="DarkBlue" FontWeight="Bold"/>
                        </TextBlock>

                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="100"/>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="100"/>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="80"/>
                            </Grid.ColumnDefinitions>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="Auto"/>
                            </Grid.RowDefinitions>

                            <!-- Lower Dose Row -->
                            <TextBlock Grid.Row="0" Grid.Column="0" Text="Lower Dose (Gy):" 
                               VerticalAlignment="Center" Margin="0,0,10,5"/>
                            <TextBox Grid.Row="0" Grid.Column="1"
                             Text="{Binding PeakLowerDose, UpdateSourceTrigger=PropertyChanged}"
                             Height="25" Margin="0,0,10,5"/>

                            <TextBlock Grid.Row="0" Grid.Column="2" Text="Volume (%):" 
                               VerticalAlignment="Center" Margin="0,0,10,5"/>
                            <TextBox Grid.Row="0" Grid.Column="3"
                             Text="{Binding PeakLowerVolume, UpdateSourceTrigger=PropertyChanged}"
                             Height="25" Margin="0,0,10,5"/>

                            <TextBlock Grid.Row="0" Grid.Column="4" Text="Priority:" 
                               VerticalAlignment="Center" Margin="0,0,10,5"/>
                            <TextBox Grid.Row="0" Grid.Column="5"
                             Text="{Binding PeakLowerPriority, UpdateSourceTrigger=PropertyChanged}"
                             Height="25" Margin="0,0,0,5"/>

                            <!-- Mean Dose Row -->
                            <TextBlock Grid.Row="1" Grid.Column="0" Text="Mean Dose (Gy):" 
                               VerticalAlignment="Center" Margin="0,0,10,5"/>
                            <TextBox Grid.Row="1" Grid.Column="1"
                             Text="{Binding PeakMeanDose, UpdateSourceTrigger=PropertyChanged}"
                             Height="25" Margin="0,0,10,5"/>

                            <TextBlock Grid.Row="1" Grid.Column="4" Text="Priority:" 
                               VerticalAlignment="Center" Margin="0,0,10,5"/>
                            <TextBox Grid.Row="1" Grid.Column="5"
                             Text="{Binding PeakMeanPriority, UpdateSourceTrigger=PropertyChanged}"
                             Height="25" Margin="0,0,0,5"/>
                        </Grid>
                    </StackPanel>
                </Border>

                <!-- Valley Objectives Section -->
                <Border BorderBrush="LightGray" BorderThickness="1" Padding="10" Background="LightCyan">
                    <StackPanel>
                        <TextBlock Text="Valley Objectives (Low Dose Regions)" 
                           FontWeight="Bold" FontSize="13"
                           Margin="0,0,0,10"/>

                        <TextBlock TextWrapping="Wrap" Margin="0,0,0,5">
                    <Run Text="Structure: " FontWeight="SemiBold"/>
                    <Run Text="{Binding SelectedValleyStructure, Mode=OneWay}" Foreground="DarkGreen" FontWeight="Bold"/>
                        </TextBlock>

                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="100"/>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="100"/>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="80"/>
                            </Grid.ColumnDefinitions>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="Auto"/>
                            </Grid.RowDefinitions>

                            <!-- Upper Dose Row -->
                            <TextBlock Grid.Row="0" Grid.Column="0" Text="Upper Dose (Gy):" 
                               VerticalAlignment="Center" Margin="0,0,10,5"/>
                            <TextBox Grid.Row="0" Grid.Column="1"
                             Text="{Binding ValleyUpperDose, UpdateSourceTrigger=PropertyChanged}"
                             Height="25" Margin="0,0,10,5"/>

                            <TextBlock Grid.Row="0" Grid.Column="2" Text="Volume (%):" 
                               VerticalAlignment="Center" Margin="0,0,10,5"/>
                            <TextBox Grid.Row="0" Grid.Column="3"
                             Text="{Binding ValleyUpperVolume, UpdateSourceTrigger=PropertyChanged}"
                             Height="25" Margin="0,0,10,5"/>

                            <TextBlock Grid.Row="0" Grid.Column="4" Text="Priority:" 
                               VerticalAlignment="Center" Margin="0,0,10,5"/>
                            <TextBox Grid.Row="0" Grid.Column="5"
                             Text="{Binding ValleyUpperPriority, UpdateSourceTrigger=PropertyChanged}"
                             Height="25" Margin="0,0,0,5"/>

                            <!-- Mean Dose Row -->
                            <TextBlock Grid.Row="1" Grid.Column="0" Text="Mean Dose (Gy):" 
                               VerticalAlignment="Center" Margin="0,0,10,5"/>
                            <TextBox Grid.Row="1" Grid.Column="1"
                             Text="{Binding ValleyMeanDose, UpdateSourceTrigger=PropertyChanged}"
                             Height="25" Margin="0,0,10,5"/>

                            <TextBlock Grid.Row="1" Grid.Column="4" Text="Priority:" 
                               VerticalAlignment="Center" Margin="0,0,10,5"/>
                            <TextBox Grid.Row="1" Grid.Column="5"
                             Text="{Binding ValleyMeanPriority, UpdateSourceTrigger=PropertyChanged}"
                             Height="25" Margin="0,0,0,5"/>
                        </Grid>
                    </StackPanel>
                </Border>

            </StackPanel>
        </GroupBox>

        <StackPanel Grid.Row="3" 
                    Orientation="Horizontal" 
                    Margin="0,0,0,10">
            <Button Content="Load Objectives" 
                    Command="{Binding GenerateObjectivesCommand}"
                    Width="150" 
                    Height="30" 
                    Margin="0,0,10,0"
                    ToolTip="Generate optimization parameters based on standard template"/>

            <Button Content="Create Objectives" 
                    Command="{Binding CreateObjectivesCommand}"
                    Width="150" 
                    Height="30"
                    ToolTip="Create optimization objectives in plan using current parameter values"/>
        </StackPanel>

        <Border Grid.Row="4" 
                Background="#FFFFEBCD" 
                BorderBrush="#FFD2691E" 
                BorderThickness="1" 
                Padding="10"
                Margin="0,0,0,10"
                Visibility="{Binding ValidationVisible, Converter={StaticResource BooleanToVisibilityConverter}}">
            <TextBlock Text="{Binding ValidationText}" 
                       Foreground="#FF8B0000"
                       FontWeight="SemiBold"
                       TextWrapping="Wrap"/>
        </Border>

        <ProgressBar Grid.Row="5" 
                     Height="20" 
                     Minimum="0" 
                     Maximum="100"
                     Value="{Binding ProgressValue}"
                     Margin="0,0,0,10"/>

        <Border Grid.Row="6" 
                BorderBrush="Gray" 
                BorderThickness="1" 
                Padding="5">
            <ScrollViewer VerticalScrollBarVisibility="Auto">
                <TextBox Text="{Binding Output, Mode=OneWay}" 
                         FontFamily="Consolas" 
                         FontSize="12"
                         TextWrapping="Wrap"
                         IsReadOnly="True"
                         Background="White"
                         BorderThickness="0"/>
            </ScrollViewer>
        </Border>
    </Grid>
</UserControl>